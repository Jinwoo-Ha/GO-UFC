{% extends 'base.html' %}
{% load static %}

{% block title %}UFC Chat Room{% endblock %}

{% block content %}
<style>
    .chat-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        max-width: 1200px;
        margin: 20px auto;
        background-color: #36393f;
        box-shadow: 0 2px 10px 0 rgba(0,0,0,.2);
        border-radius: 5px;
        overflow: hidden;
        height: 80vh;
    }
    .chat-header {
        background-color: #202225;
        color: #ffffff;
        padding: 15px 20px;
        font-size: 18px;
        font-weight: bold;
        border-bottom: 1px solid #2f3136;
    }
    .system-message {
        color: #72767d;
        font-style: italic;
        text-align: center;
        font-size: 12px;
        padding: 5px 0;
    }
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background-color: #36393f;
        display: flex;
        flex-direction: column;
    }
    .message-container {
        display: flex;
        flex-direction: column;
        margin-bottom: 10px;
        max-width: 70%;
    }
    .message-container.self {
        align-self: flex-end;
    }
    .message-container.other {
        align-self: flex-start;
    }
    .message {
        padding: 10px 15px;
        border-radius: 4px;
        word-wrap: break-word;
    }
    .message-container.self .message {
        background-color: #0084ff;
        color: white;
    }
    .message-container.other .message {
        background-color: #ffffff;
        color: black;
    }
    .chat-input {
        display: flex;
        padding: 20px;
        background-color: #40444b;
        border-top: 1px solid #2f3136;
    }
    #chat-message-input {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 5px;
        background-color: #40444b;
        color: #dcddde;
        font-size: 14px;
    }
    #chat-message-submit {
        padding: 10px 20px;
        border: none;
        background-color: #d20a0a;
        color: #ffffff;
        border-radius: 3px;
        font-size: 14px;
        cursor: pointer;
        margin-left: 10px;
        transition: background-color 0.3s ease;
    }
    #chat-message-submit:hover {
        background-color: #b30909;
    }
</style>

<div class="chat-container">
    <div class="chat-header">
        실시간 채팅방
    </div>
    <div id="system-message" class="system-message"></div>
    <div id="chat-messages" class="chat-messages">
        <!-- Chat messages will be dynamically inserted here -->
    </div>
    <div class="chat-input">
        <input type="text" id="chat-message-input" placeholder="자유롭게 채팅해보세요">
        <button id="chat-message-submit">전송</button>
    </div>
</div>

<script>
    const currentUser = "{{ request.user.username }}";
    const chatSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/chat/'
    );
    let messageCounter = 0;

    chatSocket.onopen = function(e) {
        console.log("WebSocket connection established");
        addSystemMessage("You have connected to the chat room.");
    };

    chatSocket.onerror = function(e) {
        console.error("WebSocket error occurred:", e);
        addSystemMessage("An error occurred. Please refresh the page.");
    };

    chatSocket.onclose = function(e) {
        console.log("WebSocket connection closed");
        addSystemMessage("You have been disconnected from the chat room.");
    };

    chatSocket.onmessage = function(e) {
        console.log("Message received:", e.data);
        const data = JSON.parse(e.data);
        addMessageToChat(data.sender === currentUser, data.message);
    };

    document.querySelector('#chat-message-submit').onclick = sendMessage;
    document.querySelector('#chat-message-input').onkeyup = function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    };

    function sendMessage() {
        const messageInputDom = document.querySelector('#chat-message-input');
        const message = messageInputDom.value;
        if (message.trim() !== '') {
            const messageId = `${currentUser}-${messageCounter++}`;
            chatSocket.send(JSON.stringify({
                'sender': currentUser,
                'message': message,
                'id': messageId
            }));
            messageInputDom.value = '';
        }
    }

    function addSystemMessage(message) {
        const systemMessageElement = document.getElementById('system-message');
        systemMessageElement.textContent = message;
    }

    function addMessageToChat(isSelf, message) {
        const messageDisplay = document.getElementById('chat-messages');
        const messageContainer = document.createElement('div');
        messageContainer.classList.add('message-container');
        messageContainer.classList.add(isSelf ? 'self' : 'other');

        const messageElement = document.createElement('div');
        messageElement.classList.add('message');
        messageElement.textContent = message;

        messageContainer.appendChild(messageElement);
        
        messageDisplay.appendChild(messageContainer);
        messageDisplay.scrollTop = messageDisplay.scrollHeight;
    }
</script>
{% endblock %}